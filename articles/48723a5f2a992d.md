---
title: "Goã§æ¨™æº–å…¥åŠ›ã‚’å—ã‘å–ã‚‹é–¢æ•°ã‚’ãƒ†ã‚¹ãƒˆã—ãŸã„"
emoji: "ğŸ§ª"
type: "tech"
topics: ["go", "golang", "test"]
published: false
---

## ã‚ã‚‰ã™ã˜
- Goã®ãƒ†ã‚¹ãƒˆæ›¸ãã¾ãã‚‹ãœã²ã‚ƒã£ã¯ãƒ¼ã¨ã—ã¦ã„ãŸã‚‰ã€æ¨™æº–å…¥åŠ›ã‚’ä½¿ã†é–¢æ•°ã§ã‚¨ãƒ©ãƒ¼ãŒâ€¦ã€‚
- ã©ã†ã—ãŸã‚‰ãˆãˆã­ã‚“â€¦ã€‚
- ç­”ãˆã‚’æ±‚ã‚ã¦ãƒãƒƒãƒˆã®æµ·ã‚’æ¼‚ã†ã¨ã€`os.Stdin`ã‚’ç½®ãæ›ãˆã‚‹ã®ã˜ã‚ƒã€ã¨ã„ã†çŸ¥è¦‹ãŒ
- ã„ã‚„ã„ã‚„ãã‚“ãªãã‚“ãªã€ã¨æ€ã£ã¦Goæœ¬ä½“ã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’è¦‹ã‚‹ã¨ã€`Stdin`ã®ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã§ã‚‚ã¾ã•ã—ããã‚“ãªã“ã¨ã‚’ã—ã¦ã‚‹ã˜ã‚ƒãªã„ã§ã™ã‹
- ã¨ã„ã†ã“ã¨ã§ãã‚Œã«å‰‡ã£ã¦ãƒˆãƒ©ã‚¤ã—ã¦ã¿ã¾ã™

## ä½¿ã†ã‚‚ã®
- Go 1.17
- `os`ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸

## èª¿ã¹ã‚‚ã®
- `os.Stdin`ã®è¿”ã‚Šå€¤ã¯`*os.File`ã€‚ãã‚Œã¨åŒã˜æˆ»ã‚Šå€¤ã‚’ä¸ãˆã‚‹é–¢æ•°ãªã‚‰ç½®ãæ›ãˆã‚‰ã‚Œã‚‹
- æ„å¤–ã¨é¸æŠè‚¢ãŒå°‘ãªã„
- å¦¥å½“ãã†ãªã¨ã“ã‚ã ã¨`os.CreateTemp`ãŒã‚ã‚Šãã†ã€‚â€»Go1.16ä»¥å‰ã¯`ioutil.TempFile`
- æ¨™æº–å…¥åŠ›ã—ãŸã„æ–‡å­—åˆ—ã‚’æ›¸ãè¾¼ã‚“ã§ã€ãƒ•ã‚¡ã‚¤ãƒ«ã®å…ˆé ­ã«seekã—ã¦ã€ä½¿ã„çµ‚ã‚ã£ãŸã‚‰æ¶ˆã™ã¨ã„ã†æµã‚Œã«ãªã‚Šãã†
- çµæœçš„ã«ãƒãƒƒãƒˆã§è¦‹ã‹ã‘ãŸã‚„ã‚Šæ–¹ã¨ã»ã¼ç­‰ä¾¡
- ã‚‚ã‚ã‚‚ã‚ã‚’deferã—å¿˜ã‚Œã‚‹è‡ªä¿¡ã—ã‹ãªã„ã®ã§ã€æ¬¡ã®ã‚ˆã†ã«å®Ÿè£…ã—ã¦å°‘ã—ã¯å¿˜ã‚Œã¥ã‚‰ã„ã‚ˆã†ã«ã—ã¾ã—ãŸã€‚

```go
// StdinAlt returns Alt(*os.File), closer(func), error
// Alt: intended to replace os.Stdin while test
// closer: Close and remove files internally generated by ALt
func StdiinAlt(s string) (*os.File, func(*os.File) error, error) {
	f, err := os.CreateTemp("", "tmp")
	if err != nil {
		return nil, nil, err
	}
	if _, err := f.Write([]byte(s)); err != nil {
		return nil, nil, err
	}
	// jump to head
	f.Seek(0, 0)

	closer := func(file *os.File) error {
		if err := file.Close(); err != nil {
			return err
		}
		os.Remove(file.Name())
		return nil
	}
	return f, closer, nil
}

func TestStdinAlt(t *testing.T) {
	alt, closer, _ := StdiinAlt("test")
	defer closer(alt)

	old := os.Stdin
	defer func() { os.Stdin = old }()

	os.Stdin = alt
	sc := bufio.NewScanner(os.Stdin)
	sc.Scan()
	s := sc.Text()
	if s != "test" {
		t.Errorf("got %s", s)
	}
}
```
