---
title: "AWS Amplifyã®APIå…¥åŠ›ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿç¾æ–¹æ³•"
emoji: "ğŸ’½"
type: "tech"
topics: ["aws", "graphql", "amplify", "appsync"]
published: true
---

## ã“ã®è¨˜äº‹ã¯ä½•
- Amplify CLIã‚’ä½¿ã†ã¨ç°¡å˜ã«AppSync+DynamoDBã‚’ä½¿ã£ãŸGraphQL APIã‚’ä½œæˆå¯èƒ½ã§ã™ã€‚ï¼ˆ[å…¬å¼ãƒªãƒ³ã‚¯](https://docs.amplify.aws/cli/graphql-transformer/overview)ï¼‰
- é–‹ç™ºè€…ãŒä¸‹è¨˜ã®ã‚ˆã†ãªschemaã‚’å®šç¾©ã™ã‚‹ã“ã¨ã§ã€Amplify CLIã¯DynamoDBã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚„ã€AppSyncã®ãƒªã‚¾ãƒ«ãƒ(query, mutation, subscribeç”¨)ã‚’ç”Ÿæˆã—ã¦ãã‚Œã¾ã™ã€‚

:::details schemaã®ä¾‹
```graphql
type Blog @model {
  id: ID!
  name: String!
  posts: [Post] @connection(name: "BlogPosts")
}
type Post @model {
  id: ID!
  title: String!
  blog: Blog @connection(name: "BlogPosts")
  comments: [Comment] @connection(name: "PostComments")
}
type Comment @model {
  id: ID!
  content: String
  post: Post @connection(name: "PostComments")
}
```
:::

- ä¸Šè¨˜ã®ä¾‹ä¸­ã«ã‚ã‚‹`@model`ã‚„`@connection`ã‚’ãƒ‡ã‚£ãƒ¬ã‚¯ãƒ†ã‚£ãƒ–ã¨å‘¼ã³ã€ã“ã‚Œã«ã‚ˆã£ã¦schemaã‹ã‚‰ã©ã®ã‚ˆã†ã«ãƒªã‚¾ãƒ«ãƒã‚’ç”Ÿæˆã™ã‚‹ã‹ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã—ã¦ã„ã¾ã™ï¼ˆã–ã£ãã‚Šï¼‰ã€‚
- Issueã‚‚å‡ºã¦è­°è«–ã•ã‚Œã¦ã„ã‚‹ã®ã§ãã®ã†ã¡å®Ÿè£…ã•ã‚Œãã†ã§ã™ãŒã€**ç¾çŠ¶ã¯å…¥åŠ›ã«å¯¾ã™ã‚‹ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®šç¾©ã™ã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒ†ã‚£ãƒ–ã¯ã‚ã‚Šã¾ã›ã‚“**ã€‚[ã“ã¡ã‚‰](https://zenn.dev/foxtail88/articles/7ea20168cc597d)ã®é–‹ç™ºã‚’ã™ã‚‹æ™‚ã«ã€ãƒ¦ãƒ¼ã‚¶å…¥åŠ›ã‚’DynamoDBã«æ›¸ãè¾¼ã‚€å¿…è¦ãŒã‚ã£ãŸã®ã§ã™ãŒã€ã€Œ**ã‚ã‚Œã€ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãŒç„¡ã„ã¨ã‹æ€–ã™ããªã„â€¦ï¼Ÿ**ã€ã¨ãªã‚Šã¾ã—ãŸã€‚
- ã—ãŸãŒã£ã¦ã€ä¸€åº¦Amplify CLIãŒç”Ÿæˆã—ãŸ`.vtl`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç›´æ¥ç·¨é›†ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™^[ã‚«ã‚¹ã‚¿ãƒ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒ†ã‚£ãƒ–ã‚’ä½œã‚‹æ–¹æ³•ã‚‚ã‚ã‚Šã€Amplifyã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§è§£èª¬ã•ã‚Œã¦ã„ã¾ã™ãŒã€ç§ã¯ãã“ã«ç€æ‰‹ã™ã‚‹ã‚¬ãƒƒãƒ„ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸâ€¦ã€‚]ã€‚ãã®æ–¹æ³•ã‚’å‚™å¿˜éŒ²ã¨ã—ã¦æ®‹ã—ã¾ã™ã€‚

## å‰æ
- Amplify CLI 3.3.26

## å•é¡Œè¨­å®š
æ¬¡ã®ã‚ˆã†ãªschemaã‚’å®šç¾©ã—ãŸæ™‚ã«ã€idã®é•·ã•ã«åˆ¶é™ã‚’è¨­ã‘ãŸã„ã¨ã—ã¾ã™ã€‚ï¼ˆä¾‹ãˆã°ãƒ–ãƒ©ãƒ³ã‚¯ã¯ç¦æ­¢ã‹ã¤50æ–‡å­—æœªæº€ã¨ã™ã‚‹ï¼‰

```graphql:schema.graphql
type Fav @model
  @key(fields:["owner", "id"])
  owner: ID!
  id: ID!
}
```

## æ‰‹é †
(amplify apiã®è¿½åŠ ã¯äº‹å‰ã«æ¸ˆã‚“ã§ã„ã‚‹ã‚‚ã®ã¨ã—ã¦â€¦)
1. `amplify push`ã‚’å®Ÿè¡Œã—ã¦ãƒªã‚¾ãƒ«ãƒã‚’ç”Ÿæˆã™ã‚‹
2. ç”Ÿæˆã•ã‚ŒãŸãƒªã‚¾ãƒ«ãƒã®ã†ã¡ã€ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã®è¿½åŠ ãŒå¿…è¦ãªå‡¦ç†ç”¨ã®ãƒªã‚¾ãƒ«ãƒ(ä¾‹ãˆã°CreateFavãªã©)ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦æŒ‡å®šå ´æ‰€ã«ä¿å­˜ã™ã‚‹ã€‚

:::details ãƒªã‚¾ãƒ«ãƒã®ç”Ÿæˆå ´æ‰€
```shell
ProjectRoot
  |- amplify
      |- backend
          |- api
	      |- yourApiName
	          |- build
		  |   |- resolvers  --- â€»ã“ã“ã«ç”Ÿæˆã•ã‚Œã‚‹
		  |
		  |- resolvers -------- â€»ã“ã“ã«ã‚³ãƒ”ãƒ¼ã—ã¦ä¿å­˜ã™ã‚‹
```
:::

:::message 
2ã®æ‰‹é †ã§æŒ‡å®šã—ãŸãƒ•ã‚©ãƒ«ãƒ€ã«`.vtl`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜ã™ã‚‹ã¨ã€è‡ªå‹•ç”Ÿæˆã—ãŸãƒªã‚¾ãƒ«ãƒã‚’ä¸Šæ›¸ãã™ã‚‹ã“ã¨ã«ãªã‚‹ã€‚
:::

:::message alert
ãã®ãŸã‚ã€ã‚‚ã—é€”ä¸­ã§ãƒ‡ãƒ¼ã‚¿æ§‹é€ ãªã©ã‚’å¤‰ãˆãŸå ´åˆã«ã¯å¤ã„ãƒªã‚¾ãƒ«ãƒã‚’å‰Šé™¤ã™ã‚‹ã“ã¨
:::

3. ã‚³ãƒ”ãƒ¼ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¬¡ã®ã‚ˆã†ã«ç·¨é›†ã™ã‚‹ã€‚æ­£ç›´VTLã®è¨˜è¿°æ–¹æ³•ãŒåˆ†ã‹ã‚‰ãªã„ã®ã§ã€æŒ¿å…¥å ´æ‰€ã¯æ‰‹æ¢ã‚Šæ„ŸãŒã‚ã‚Šã¾ã™ãŒã€è‡ªå‹•ç”Ÿæˆã•ã‚ŒãŸã‚³ãƒ¡ãƒ³ãƒˆã‚’æ‰‹ãŒã‹ã‚Šã«ã€primary keyã®ä»˜ä¸å‰ã«ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿæ–½ã™ã‚‹ã‚ˆã†ã«ã€æ¬¡ã®ã‚ˆã†ãªä½ç½®ã«æŒ¿å…¥ã—ã¦ã„ã¾ã™ã€‚

```diff vtl
(ç•¥)
+ ## Custom for input validation
+ #if($util.isNullOrBlank($ctx.args.input.id))
+   $util.appendError("id must exist", "id", null, $ctx.args.input.id)
+ #end 
+ #if($ctx.args.input.id.length() > 50))
+   $util.appendError("The request would not be proper", "id", null, ctx.args.input.id)
+ #end

+ #if($ctx.outErrors.size() > 0)
+   #return($ctx.outErrors)
+ #end

## [Start] Set the primary @key. **
#set( $modelObjectKey = {
  "owner": $util.dynamodb.toDynamoDB($ctx.args.input.owner),
  "id": $util.dynamodb.toDynamoDB($ctx.args.input.id)
} )
## [End] Set the primary @key. **

## [Start] Prepare DynamoDB PutItem Request. **
(ç•¥)
```

4. ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¸Šæ›¸ãä¿å­˜ã—ãŸå¾Œã€å†åº¦`amplify push`ã™ã‚‹ã€‚


## ãŠã‚ã‚Šã«
ãŠç–²ã‚Œã•ã¾ã§ã—ãŸã€‚è¨­å®šæ–¹æ³•ã¯ä»¥ä¸Šã¨ãªã‚Šã¾ã™ã€‚å¿µã®ãŸã‚AppSyncã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãªã©ã§è©¦ã—ã«ã‚¯ã‚¨ãƒªã‚’è¡Œã„ã€ç‹™ã„é€šã‚Šã«ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãŒæ©Ÿèƒ½ã—ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ã¿ã¦ä¸‹ã•ã„ã€‚