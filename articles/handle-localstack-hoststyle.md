---
title: "LocalStackでS3の仮想ホスト形式パスを攻略するまでの冒険"
emoji: "✨"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["go", "localstack", "aws", "s3", "docker"]
published: false
---

## この記事は何
AWSを使用するアプリケーションのローカル開発環境構築において、本物のAWSを使用しないで済む[LocalStack](https://www.localstack.cloud)はありがたい存在です。万が一環境を壊しても問題ないという安心感は心強いです。

筆者は最近、本物のAWSに依存したローカル開発環境を再構築する機会に恵まれたのですが、**S3のパス形式、SDK仕様、LocalStack仕様の三者が織りなす沼にハマって数日を溶かしました**。なんとか解決することができましたが、なかなか解説の記事を見かけませんでした。本記事は同じ沼にはまる人を救いたい…！という思いで記しています。

## 本記事の対象読者
- LocalStackが好きな人
- LocalStackを使い始めたい人

## 前提条件
- LocalStackはホストPC上でDockerコンテナとして実行する。
  - イメージは`localstack/localstack:3.7.2`。
  - S33とLambdaを実行する。(詳細はサンプルアプリケーションの章を参照)
- LocalStackのS3には、1.LocalStackとは別のコンテナ(Appコンテナ)から、2.LocalStackが作成するLambdaから、また、3.署名付きURLを通じてホストPCのブラウザから、それぞれアクセスすることとする。(詳細はサンプルアプリケーションの章を参照)

## 結論
- AWS SDKやCLIの操作をLocalStackに向けるにはエンドポイントの指定が必要。例えばLocalStackのDockerコンテナをチュートリアル通りに使う場合であれば`http://localhost:4566`。しかしこの形式の指定では狙い通りに動作させられないケースがある。
- LocalStackのS3のエンドポイントは`http://<host>/<bucket>/<object-key>`のようなパス形式も、`http://<bucket>.s3.<host>/<object-key>`のような仮想ホスト形式も、どちらもとりうる。
- エンドポイントは、作成するS3の署名付きURLにも影響する。パス形式を使う場合は署名付きURLもパス形式になり、仮想ホスト形式でエンドポイントを指定する場合には仮想ホスト形式の署名付きURLになる[^1]。したがって、従来から仮想ホスト形式の署名付きURLを使用しており、その形式を変えたくない場合にはエンドポイントを`http://<bucket>.s3.<host>/<object-key>`の形式にする必要がある。**その場合、名前解決が必要になるが、ユースケースごとに使用すべき名前解決方法が異なる**。
  - まず、**指定するエンドポイントのホストは`s3.localhost.localstack.cloud`にすることを推奨**。(詳細は本文参照) ただしLocalStackコンテナが作成するリソース(例えばLambdaコンテナ)はエンドポイントの指定すら不要なので、以下の内容は当てはまらない。
  - 使用すべき名前解決の方法は以下の通り。
    - ホストPC: LocalStack社が登録済みのDNSレコードを用いる。つまり**特に必要な処置はない**。`s3.localhost.localstack.cloud`が`127.0.0.1`に解決されるため、ホストPCのlocalhostに向く。
    - LocalStack以外のAppコンテナ: **LocalStackコンテナのIPアドレスを固定した上で、LocalStackコンテナをDNSサーバーとして用いる**。`s3.localhost.localstack.cloud`が`<LocalStackコンテナのIPアドレス>`に解決される。

[^1]: ただしエンドポイントを仮想ホスト形式で指定したものの、LocalStackがURLからバケット名を解決できなかった場合にはパス形式にフォールバックするなどの例外もある。

## イントロダクション
### LocalStackとは

### S3のパス形式

### SDK使用時の課題

## サンプルアプリケーションを通じた解説

### サンプルアプリケーションの構成

### アプリケーションの設定

### Lambdaの設定

### サンプルアプリケーションを使った実験のまとめ

## おわりに
